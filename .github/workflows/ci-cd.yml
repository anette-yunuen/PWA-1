name: CI/CD PWA-1

on:
  push:
    branches:
      - main
  # opcional: para poder seguir lanzándolo manualmente desde Actions
  workflow_dispatch: {}

jobs:
  tests:
    name: Run API tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install API dependencies
        working-directory: ./api
        run: npm ci

      - name: Run API tests (Jest + Supertest)
        working-directory: ./api
        run: npm test

  deploy:
    name: Deploy to VPS with docker compose
    needs: tests          # <- SOLO corre si los tests pasan
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo "Conectado al VPS, desplegando PWA-1 con backend y nginx proxy..."

            cd /srv/apps/integradora-api-proxy/PWA-1

            echo "Haciendo git pull..."
            git pull

            echo "Bajando contenedores anteriores..."
            docker compose down

            echo "Levantando contenedores nuevos con build..."
            docker compose up -d --build

            echo "Limpiando imágenes viejas..."
            docker image prune -f

            echo "Deploy completado."
